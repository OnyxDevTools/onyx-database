# filename: .github/workflows/release.yml
name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  version:
    if: startsWith(github.ref, 'refs/heads/')
    runs-on: ubuntu-latest
    env:
      ONYX_DATABASE_ID: ${{ secrets.ONYX_DATABASE_ID }}
      ONYX_DATABASE_API_KEY: ${{ secrets.ONYX_DATABASE_API_KEY }}
      ONYX_DATABASE_API_SECRET: ${{ secrets.ONYX_DATABASE_API_SECRET }}
      ONYX_DEBUG: "true"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - run: npm test
      - run: npm run test:smoke
      - name: Open/Update Changesets Version PR
        uses: changesets/action@v1
        with:
          version: npm run changeset version
          # No publish here; publish happens on tag below
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    env:
      ONYX_DATABASE_ID: ${{ secrets.ONYX_DATABASE_ID }}
      ONYX_DATABASE_API_KEY: ${{ secrets.ONYX_DATABASE_API_KEY }}
      ONYX_DATABASE_API_SECRET: ${{ secrets.ONYX_DATABASE_API_SECRET }}
      ONYX_DEBUG: "true"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
      - run: npm ci
      - run: npm run build
      - run: npm test
      - run: npm run test:smoke
      - name: Generate npm OTP
        id: otp
        run: |
          node - <<'NODE'
          const { createHmac } = require('crypto');

          const secretBase32 = process.env.NPM_TOTP_SECRET;
          if (!secretBase32) {
            console.error('Missing NPM_TOTP_SECRET secret');
            process.exit(1);
          }

          const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
          const clean = secretBase32.replace(/=+$/g, '').toUpperCase();
          let bits = '';
          for (const ch of clean) {
            const idx = alphabet.indexOf(ch);
            if (idx === -1) continue;
            bits += idx.toString(2).padStart(5, '0');
          }
          const bytes = [];
          for (let i = 0; i + 8 <= bits.length; i += 8) {
            bytes.push(parseInt(bits.slice(i, i + 8), 2));
          }
          const key = Buffer.from(bytes);

          const step = 30;
          const counter = Buffer.alloc(8);
          counter.writeBigUInt64BE(BigInt(Math.floor(Date.now() / 1000 / step)));
          const hmac = createHmac('sha1', key).update(counter).digest();
          const offset = hmac[hmac.length - 1] & 0xf;
          const code = ((hmac.readUInt32BE(offset) & 0x7fffffff) % 1_000_000)
            .toString()
            .padStart(6, '0');

          require('fs').appendFileSync(process.env.GITHUB_OUTPUT, `code=${code}\n`);
          console.log('Generated OTP for npm publish');
          NODE
        env:
          NPM_TOTP_SECRET: ${{ secrets.NPM_TOTP_SECRET }}
      - name: Publish to npm (with provenance)
        run: npm publish --provenance --access public --otp ${{ steps.otp.outputs.code }}
